{% extends "base.html" %}
{% block title %}Solution History - {{ problem_title }} - Argus{% endblock %}
{% block content %}
<div class="animate-fade-in">
    <div class="mb-8">
        <a href="/problem/{{ slug }}" class="text-sm text-gray-500 hover:text-indigo-400 transition-colors">&larr; Back to problem</a>
        <h1 class="text-3xl font-bold text-gradient mt-2 mb-1">Solution History</h1>
        <p class="text-sm text-gray-500">{{ problem_title }} &mdash; {{ solutions|length }} solve attempt{{ 's' if solutions|length != 1 }}</p>
    </div>

    {% if solutions %}
    <div class="space-y-4">
        {% for sol in solutions %}
        <details class="glass rounded-2xl overflow-hidden glow-sm">
            <summary class="px-6 py-5 cursor-pointer hover:bg-white/5 transition flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="text-xs font-bold px-2.5 py-1 rounded-full"
                          style="{% if sol.solved %}background:rgba(52,211,153,0.15);color:#34d399{% else %}background:rgba(248,113,113,0.15);color:#f87171{% endif %}">
                        {{ 'ACCEPTED' if sol.solved else 'REJECTED' }}
                    </span>
                    <span class="text-gray-300 font-medium">Score: {{ (sol.score * 100)|round|int }}%</span>
                    <span class="text-gray-500 text-sm">{{ sol.attempts }} attempt{{ 's' if sol.attempts != 1 }}</span>
                </div>
                <span class="text-xs text-gray-600 font-mono">{{ sol.created_at }}</span>
            </summary>
            <div class="px-6 pb-6 border-t border-white/5 pt-4 space-y-4">
                <!-- Solution Code -->
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-xs font-semibold text-indigo-400 uppercase tracking-wider">Code</h3>
                        <button onclick="navigator.clipboard.writeText(this.closest('details').querySelector('code').textContent)"
                                class="glass-light text-gray-400 hover:text-gray-200 px-3 py-1 rounded-lg text-xs font-medium transition-all hover:bg-white/10">
                            Copy
                        </button>
                    </div>
                    <pre class="glass-light rounded-xl p-5 overflow-x-auto"><code style="color:#22d3ee" class="font-mono text-sm">{{ sol.code }}</code></pre>
                </div>

                <!-- Attempt History -->
                {% set history = sol.history_json | tojson | safe %}
                <div>
                    <h3 class="text-xs font-semibold text-indigo-400 uppercase tracking-wider mb-3">Attempt Details</h3>
                    <div class="space-y-2" id="history-{{ sol.id }}"></div>
                    <script>
                    (function() {
                        const history = {{ sol.history_json | safe }};
                        const container = document.getElementById('history-{{ sol.id }}');
                        if (!history || !history.length) {
                            container.innerHTML = '<p class="text-gray-600 text-sm">No detailed history available.</p>';
                            return;
                        }
                        history.forEach(function(attempt) {
                            const isAcc = attempt.verdict === 'ACCEPTED';
                            const div = document.createElement('div');
                            div.className = 'glass-light rounded-lg p-4 text-sm';
                            let html = '<div class="flex items-center justify-between mb-2">';
                            html += '<span class="text-gray-300 font-medium">Attempt ' + attempt.attempt + '</span>';
                            html += '<span class="text-xs px-2 py-0.5 rounded-full" style="' + (isAcc ? 'background:rgba(52,211,153,0.15);color:#34d399' : 'background:rgba(248,113,113,0.15);color:#f87171') + '">' + attempt.verdict + ' (' + Math.round(attempt.score * 100) + '%)</span>';
                            html += '</div>';
                            if (attempt.test_results) {
                                attempt.test_results.forEach(function(tr, i) {
                                    html += '<div class="flex items-center gap-2 text-xs">';
                                    html += '<span class="font-mono" style="color:' + (tr.passed ? '#34d399' : '#f87171') + '">' + (tr.passed ? 'PASS' : 'FAIL') + '</span>';
                                    html += '<span class="text-gray-500">' + (tr.description || 'Test ' + (i+1)) + '</span>';
                                    html += '</div>';
                                });
                            }
                            if (attempt.feedback) {
                                html += '<div class="mt-2 text-xs border-l-2 pl-3" style="border-color:rgba(251,191,36,0.3)">';
                                html += '<div><span style="color:#fbbf24" class="font-medium">Root cause:</span> <span class="text-gray-400">' + (attempt.feedback.root_cause || '') + '</span></div>';
                                html += '</div>';
                            }
                            div.innerHTML = html;
                            container.appendChild(div);
                        });
                    })();
                    </script>
                </div>
            </div>
        </details>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-16 glass rounded-2xl">
        <p class="text-gray-400">No solutions yet. Solve the problem to see history here.</p>
    </div>
    {% endif %}
</div>
{% endblock %}
